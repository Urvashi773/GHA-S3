name: Deploy to AWS S3 (Production Ready)

on:
  push:
    branches: [main]
    paths-ignore:
      - '**/*.md'
      - '.gitignore'
  pull_request:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read

env:
  BUCKET_NAME: gha-s3-website-poc
  WEBSITE_REGION: eu-north-1

jobs:
  # -----------------------------
  # JOB 1: Security & Code Quality
  # -----------------------------
  security:
    name: Security & Code Quality
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install security tools
        run: |
          npm install -g htmlhint stylelint stylelint-config-standard
        continue-on-error: true

      - name: HTML validation
        run: |
          echo "Validating HTML files..."
          npx htmlhint src/**/*.html || true
        continue-on-error: true

      - name: CSS validation
        run: |
          echo "Validating CSS files..."
          npx stylelint "src/**/*.css" --config-basedir . || true
        continue-on-error: true

      - name: Check for secrets
        run: |
          echo "Scanning for exposed secrets..."
          if grep -r "AKIA" src/ 2>/dev/null; then
            echo " WARNING: Possible AWS credentials found!"
            exit 1
          fi
          echo "No exposed secrets found"

  # -----------------------------
  # JOB 2: Build & Optimize
  # -----------------------------
  build:
    name: Build & Optimize Assets
    runs-on: ubuntu-latest
    needs: security
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create build info
        run: |
          echo "Creating build metadata..."
          COMMIT_SHA="${{ github.sha }}"
          SHORT_SHA="${COMMIT_SHA:0:7}"
          BUILD_TIME=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          
          # Replace placeholder in JS
          sed -i "s/COMMIT_SHA_PLACEHOLDER/$SHORT_SHA/g" src/js/main.js
          
          # Create build info file
          cat > src/build-info.json << EOF
          {
            "commitSha": "$COMMIT_SHA",
            "shortSha": "$SHORT_SHA",
            "buildTime": "$BUILD_TIME",
            "branch": "${{ github.ref_name }}",
            "triggeredBy": "${{ github.actor }}"
          }
          EOF
          
          echo "Build info created"

      - name: Create deployment package
        run: |
          echo "Packaging website files..."
          mkdir -p dist
          cp -r src/* dist/
          
          echo "Package contents:"
          ls -lah dist/
          tree dist/ || find dist/

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: website-${{ github.sha }}
          path: dist/
          retention-days: 30

  # -----------------------------
  # JOB 3: Deploy to AWS S3
  # -----------------------------
  deploy:
    name: Deploy to S3
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: website-${{ github.sha }}
          path: dist

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Verify AWS identity
        run: |
          echo "Verifying AWS credentials..."
          aws sts get-caller-identity
          echo "Deploying to region: ${{ secrets.AWS_REGION }}"
          echo "Target bucket: ${{ env.BUCKET_NAME }}"

      - name: Backup current version
        id: backup
        run: |
          echo "Creating backup of current deployment..."
          BACKUP_TIME=$(date +%Y%m%d-%H%M%S)
          
          # Check if bucket has content
          if aws s3 ls s3://${{ env.BUCKET_NAME }}/index.html 2>/dev/null; then
            echo "Creating backup tag..."
            aws s3api put-object-tagging \
              --bucket ${{ env.BUCKET_NAME }} \
              --key index.html \
              --tagging "TagSet=[{Key=backup,Value=$BACKUP_TIME}]" || true
            echo "backup_time=$BACKUP_TIME" >> "$GITHUB_OUTPUT"
            echo "Backup tag created: $BACKUP_TIME"
          else
            echo "No existing deployment to backup"
            echo "backup_time=" >> "$GITHUB_OUTPUT"
          fi

      - name: Deploy to S3
        run: |
          echo "Deploying website to S3..."
          
          # Sync files with appropriate cache headers
          aws s3 sync dist/ s3://${{ env.BUCKET_NAME }}/ \
            --delete \
            --cache-control "public, max-age=3600" \
            --metadata-directive REPLACE
          
          # Set longer cache for static assets
          aws s3 cp s3://${{ env.BUCKET_NAME }}/css/ s3://${{ env.BUCKET_NAME }}/css/ \
            --recursive \
            --cache-control "public, max-age=31536000" \
            --metadata-directive REPLACE || true
          
          aws s3 cp s3://${{ env.BUCKET_NAME }}/js/ s3://${{ env.BUCKET_NAME }}/js/ \
            --recursive \
            --cache-control "public, max-age=31536000" \
            --metadata-directive REPLACE || true
          
          echo " Deployment completed"

      - name: Get website URL
        id: website-url
        run: |
          WEBSITE_URL=$(aws s3api get-bucket-website \
            --bucket ${{ env.BUCKET_NAME }} \
            --query '[WebsiteConfiguration.IndexDocument.Suffix]' \
            --output text 2>/dev/null || echo "")
          
          if [ -z "$WEBSITE_URL" ]; then
            WEBSITE_URL="http://${{ env.BUCKET_NAME }}.s3-website-${{ secrets.AWS_REGION }}.amazonaws.com"
          fi
          
          echo "url=$WEBSITE_URL" >> "$GITHUB_OUTPUT"
          echo "Website URL: $WEBSITE_URL"

      - name: Smoke test - Check website accessibility
        run: |
          echo "Running smoke test..."
          WEBSITE_URL="http://${{ env.BUCKET_NAME }}.s3-website-${{ env.WEBSITE_REGION }}.amazonaws.com"
          WEBSITE_URL="http://${{ env.BUCKET_NAME }}.s3-website.${{ env.WEBSITE_REGION }}.amazonaws.com"
          echo "Testing : $WEBSITE_URL"
          
          # Wait a moment for S3 to propagate
          sleep 5
          
          # Check if website is accessible
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$WEBSITE_URL")
          
          if [ "$HTTP_CODE" -eq 200 ]; then
            echo "Smoke test PASSED - Website is accessible (HTTP $HTTP_CODE)"
            
            # Additional checks
            CONTENT=$(curl -s "$WEBSITE_URL")
            if echo "$CONTENT" | grep -q "GHA S3 Deployment POC"; then
              echo " Content validation PASSED"
            else
              echo " WARNING: Expected content not found"
            fi
          else
            echo " Smoke test FAILED - HTTP code: $HTTP_CODE"
            exit 1
          fi

      - name: Verify deployment
        run: |
          echo "Verifying deployed files..."
          aws s3 ls s3://${{ env.BUCKET_NAME }}/ --recursive
          
          # Check critical files
          CRITICAL_FILES=("index.html" "css/style.css" "js/main.js")
          for file in "${CRITICAL_FILES[@]}"; do
            if aws s3 ls "s3://${{ env.BUCKET_NAME }}/$file" >/dev/null 2>&1; then
              echo " $file exists"
            else
              echo " $file is missing!"
              exit 1
            fi
          done
          
          echo " All critical files verified"

      - name: Rollback on failure
        if: failure() && steps.backup.outputs.backup_time != ''
        run: |
          echo " DEPLOYMENT FAILED - Initiating rollback..."
          
          # In a real scenario, you would restore from a backup bucket
          # or use S3 versioning to restore previous versions
          echo "Rollback process:"
          echo "1. List object versions"
          aws s3api list-object-versions \
            --bucket ${{ env.BUCKET_NAME }} \
            --prefix index.html \
            --max-items 5 || true
          
          echo " Manual rollback may be required"
          echo "Backup timestamp: ${{ steps.backup.outputs.backup_time }}"

      - name: Create deployment summary
        if: success()
        run: |
          WEBSITE_URL="http://${{ env.BUCKET_NAME }}.s3-website-${{ secrets.AWS_REGION }}.amazonaws.com"
          
          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## S3 Deployment Successful
          
          **Bucket**: \`${{ env.BUCKET_NAME }}\`
          **Region**: \`${{ secrets.AWS_REGION }}\`
          **Commit**: \`${{ github.sha }}\`
          **Branch**: \`${{ github.ref_name }}\`
          **Deployed by**: \`${{ github.actor }}\`
          **Timestamp**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          
          ###  Status
          -  Security scan: Completed
          -  Build: Successful
          -  Deployment: Successful
          -  Smoke tests: PASSED
          
          ###  Website URL
          **Live Site**: [$WEBSITE_URL]($WEBSITE_URL)
          
          ###  Quick Links
          - [S3 Bucket Console](https://${{ secrets.AWS_REGION }}.console.aws.amazon.com/s3/buckets/${{ env.BUCKET_NAME }})
          - [CloudWatch Logs](https://${{ secrets.AWS_REGION }}.console.aws.amazon.com/cloudwatch/home?region=${{ secrets.AWS_REGION }})
          
          ### ðŸ“¦ Deployed Files
          $(aws s3 ls s3://${{ env.BUCKET_NAME }}/ --recursive | head -10)
          EOF
