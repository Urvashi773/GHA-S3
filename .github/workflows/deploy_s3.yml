
name: Deploy to AWS S3 (Production Ready)

on:
  push:
    branches: [main]
    paths-ignore:
      - '**/*.md'
      - '.gitignore'
  pull_request:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read

env:
  BUCKET_NAME: gha-s3-website-poc

jobs:
  security:
    name: Security & Code Quality
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install validation tools
        run: |
          npm install -g htmlhint stylelint stylelint-config-standard

      - name: HTML validation
        run: |
          echo "Validating HTML files..."
          npx htmlhint src/**/*.html || true

      - name: CSS validation
        run: |
          echo "Validating CSS files..."
          npx stylelint "src/**/*.css" --config-basedir . || true

      - name: Check for exposed secrets
        run: |
          echo "Scanning for exposed credentials..."
          if grep -r "AKIA" src/ 2>/dev/null; then
            echo "WARNING: Possible AWS access key found."
            exit 1
          fi
          echo "No exposed credentials detected."

  build:
    name: Build & Optimize Assets
    runs-on: ubuntu-latest
    needs: security
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create build metadata
        run: |
          echo "Creating build metadata..."
          COMMIT_SHA="${{ github.sha }}"
          SHORT_SHA="${COMMIT_SHA:0:7}"
          BUILD_TIME=$(date -u +"%Y-%m-%d %H:%M:%S UTC")

          # Replace placeholder in JS
          sed -i "s/COMMIT_SHA_PLACEHOLDER/$SHORT_SHA/g" src/js/main.js

          # Build info file
          cat > src/build-info.json << EOF
          {
            "commitSha": "$COMMIT_SHA",
            "shortSha": "$SHORT_SHA",
            "buildTime": "$BUILD_TIME",
            "branch": "${{ github.ref_name }}",
            "triggeredBy": "${{ github.actor }}"
          }
          EOF

      - name: Create deployment package
        run: |
          echo "Packaging website files..."
          mkdir -p dist
          cp -r src/* dist/
          ls -lah dist/

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: website-${{ github.sha }}
          path: dist/
          retention-days: 30

  deploy:
    name: Deploy to S3
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: website-${{ github.sha }}
          path: dist

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Verify AWS identity
        run: |
          echo "Verifying AWS credentials..."
          aws sts get-caller-identity

      - name: Enable S3 static website hosting (idempotent)
        run: |
          set -e
          BUCKET="${{ env.BUCKET_NAME }}"
          if ! aws s3api get-bucket-website --bucket "$BUCKET" >/dev/null 2>&1; then
            echo "Enabling website hosting on bucket: $BUCKET"
            aws s3api put-bucket-website \
              --bucket "$BUCKET" \
              --website-configuration '{
                "IndexDocument": {"Suffix": "index.html"},
                "ErrorDocument": {"Key": "error.html"}
              }'
          else
            echo "Website hosting already enabled."
          fi
        # S3 website endpoints are HTTP-only; use CloudFront for HTTPS. (AWS docs)  # [3](https://docs.aws.amazon.com/AmazonS3/latest/userguide/HostingWebsiteOnS3Setup.html)

      - name: Deploy to S3
        run: |
          BUCKET="${{ env.BUCKET_NAME }}"
          echo "Syncing files to s3://$BUCKET/"
          # Global TTL for HTML and misc assets
          aws s3 sync dist/ "s3://$BUCKET/" \
            --delete \
            --cache-control "public, max-age=3600" \
            --metadata-directive REPLACE

          # Longer TTL for static assets
          aws s3 cp "s3://$BUCKET/css/" "s3://$BUCKET/css/" \
            --recursive \
            --cache-control "public, max-age=31536000" \
            --metadata-directive REPLACE || true

          aws s3 cp "s3://$BUCKET/js/" "s3://$BUCKET/js/" \
            --recursive \
            --cache-control "public, max-age=31536000" \
            --metadata-directive REPLACE || true

          echo "Deployment to S3 completed."

      - name: Resolve S3 website endpoint automatically
        id: resolve-endpoint
        run: |
          set -e
          BUCKET="${{ env.BUCKET_NAME }}"

          REGION=$(aws s3api get-bucket-location --bucket "$BUCKET" --query 'LocationConstraint' --output text)
          if [ "$REGION" = "None" ] || [ -z "$REGION" ]; then REGION="us-east-1"; fi

          CANDIDATE1="http://${BUCKET}.s3-website-${REGION}.amazonaws.com"
          CANDIDATE2="http://${BUCKET}.s3-website.${REGION}.amazonaws.com"

          echo "Testing candidate endpoints:"
          echo "  1) $CANDIDATE1"
          CODE1=$(curl -s -o /dev/null -w "%{http_code}" --max-time 8 "$CANDIDATE1" || echo "000")

          if [ "$CODE1" != "000" ]; then
            WEBSITE_URL="$CANDIDATE1"
          else
            echo "  2) $CANDIDATE2"
            CODE2=$(curl -s -o /dev/null -w "%{http_code}" --max-time 8 "$CANDIDATE2" || echo "000")
            WEBSITE_URL="$CANDIDATE2"
          fi

          echo "url=$WEBSITE_URL" >> "$GITHUB_OUTPUT"
          echo "Resolved website URL: $WEBSITE_URL"
        # Endpoint formats vary by region (hyphen vs dot). (AWS docs)  # [2](https://docs.aws.amazon.com/AmazonS3/latest/userguide/WebsiteEndpoints.html)

      - name: Smoke test - website accessibility
        run: |
          WEBSITE_URL="${{ steps.resolve-endpoint.outputs.url }}"
          echo "Running smoke test: $WEBSITE_URL"
          sleep 8

          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$WEBSITE_URL")
          echo "HTTP code: $HTTP_CODE"

          if [ "$HTTP_CODE" -eq 200 ]; then
            CONTENT=$(curl -s "$WEBSITE_URL")
            if echo "$CONTENT" | grep -q "GHA S3 Deployment POC"; then
              echo "Content validation passed."
            else
              echo "Warning: Expected content string not found."
            fi
          else
            echo "Smoke test failed. HTTP code: $HTTP_CODE"
            echo "Listing bucket contents for diagnostics:"
            aws s3 ls "s3://${{ env.BUCKET_NAME }}/" --recursive || true
            exit 1
          fi

      - name: Verify critical files
        run: |
          BUCKET="${{ env.BUCKET_NAME }}"
          echo "Verifying critical files..."
          for f in index.html css/style.css js/main.js; do
            if aws s3 ls "s3://$BUCKET/$f" >/dev/null 2>&1; then
              echo "Verified: $f"
            else
              echo "Missing: $f"
              exit 1
            fi
          done
          echo "All critical files verified."

      # Optional: invalidate CloudFront cache if a distribution ID is provided
      - name: CloudFront invalidation (optional)
        if: ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID != '' }}
        run: |
          DIST_ID="${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }}"
          echo "Creating CloudFront invalidation on distribution $DIST_ID"
          aws cloudfront create-invalidation --distribution-id "$DIST_ID" --paths "/*"
        # Use CloudFront to serve HTTPS and CDN caching. (AWS docs)  # [3](https://docs.aws.amazon.com/AmazonS3/latest/userguide/HostingWebsiteOnS3Setup.html)

      - name: Deployment summary
        if: success()
        run: |
          WEBSITE_URL="${{ steps.resolve-endpoint.outputs.url }}"
          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## S3 Deployment Successful

          **Bucket**: \`${{ env.BUCKET_NAME }}\`  
          **Website URL**: ${WEBSITE_URL}  
          **Region (bucket)**: $(aws s3api get-bucket-location --bucket "${{ env.BUCKET_NAME }}" --query 'LocationConstraint' --output text)  
          **Commit**: \`${{ github.sha }}\`  
          **Branch**: \`${{ github.ref_name }}\`  
          **Deployed by**: \`${{ github.actor }}\`  
          **Timestamp**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")

          ### Status
          - Security & Quality: Completed
          - Build: Successful
          - Deploy: Successful
          - Smoke Test: PASSED

          ### Quick Links
          - S3 Bucket: https://${{ secrets.AWS_REGION }}.console.aws.amazon.com/s3/buckets/${{ env.BUCKET_NAME }}
          - CloudWatch (region console): https://${{ secrets.AWS_REGION }}.console.aws.amazon.com/cloudwatch/home?region=${{ secrets.AWS_REGION }}

          ### Recent Files
          $(aws s3 ls "s3://${{ env.BUCKET_NAME }}/" --recursive | head -10)
          EOF
